<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>C2C Client</title>
    <style>
      :root {
        --bg: #0b0c10;
        --bg-2: #11131a;
        --card: #151a22;
        --card-2: #1b212c;
        --text: #eef1f5;
        --muted: #a9b4c4;
        --accent: #5eead4;
        --accent-2: #60a5fa;
        --border: #2a3342;
        --bubble-in: #1f2a37;
        --bubble-out: #0f766e;
      }

      * {
        box-sizing: border-box;
      }

      .hidden {
        display: none;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font: 15px/1.5 "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(1200px 600px at 10% -10%, #14304a 0%, transparent 55%),
          radial-gradient(900px 500px at 90% 0%, #1b3b2f 0%, transparent 50%),
          linear-gradient(180deg, #0a0b10 0%, #0b0c10 100%);
      }

      .app {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 18px 16px 22px;
        min-height: 100vh;
        max-width: 420px;
        margin: 0 auto;
      }

      #chatView:not(.hidden) {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        gap: 16px;
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      h1 {
        margin: 0 0 4px 0;
        font-size: 22px;
      }

      h2 {
        margin: 0 0 12px 0;
        font-size: 16px;
      }

      .muted {
        color: var(--muted);
        margin: 0;
        font-size: 12px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }

      .stack {
        display: grid;
        gap: 12px;
      }

      .field {
        display: grid;
        gap: 6px;
      }

      .field span {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg-2);
        color: var(--text);
        font: inherit;
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 12px;
      }

      .btn {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--card-2);
        color: var(--text);
        padding: 10px 14px;
        cursor: pointer;
        font: inherit;
      }

      .btn.primary {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        color: #06221c;
        border: none;
        font-weight: 600;
      }

      .link {
        display: inline-flex;
        margin-top: 12px;
        color: #cfe5ff;
        text-decoration: none;
        font-size: 13px;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        background: rgba(4, 6, 10, 0.7);
        z-index: 10;
      }

      .modal-backdrop.open {
        display: flex;
      }

      .modal {
        width: 100%;
        max-width: 360px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.4);
      }

      .modal.progress {
        text-align: center;
      }

      .modal.progress h3 {
        margin: 10px 0 6px;
        font-size: 16px;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 16px;
      }

      .icon-btn {
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 18px;
        cursor: pointer;
      }

      .spinner {
        width: 36px;
        height: 36px;
        margin: 6px auto 4px;
        border-radius: 50%;
        border: 3px solid rgba(94, 234, 212, 0.25);
        border-top-color: var(--accent);
        animation: spin 0.9s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .list {
        margin: 0;
        padding-left: 18px;
        color: var(--muted);
        font-size: 13px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(96, 165, 250, 0.16);
        color: #cfe5ff;
        font-size: 12px;
        border: 1px solid rgba(96, 165, 250, 0.35);
        text-decoration: none;
      }

      .entries-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
        margin-top: 6px;
      }

      .entries-trigger {
        border: 1px solid rgba(94, 234, 212, 0.5);
        border-radius: 999px;
        background: rgba(94, 234, 212, 0.15);
        color: #bffbf0;
        font-size: 12px;
        padding: 4px 10px;
        cursor: pointer;
      }

      .entries-panel {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        min-width: 200px;
        max-width: 260px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-6px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        z-index: 2;
      }

      .entries-wrap:hover .entries-panel,
      .entries-wrap:focus-within .entries-panel {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .entries-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 6px;
      }

      .entries-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(15, 16, 24, 0.4);
        font-size: 12px;
        color: var(--text);
      }

      .entries-item.is-self {
        color: #7dd3fc;
      }

      .entries-item.is-owner {
        border: 1px solid rgba(96, 165, 250, 0.5);
      }

      .owner-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(96, 165, 250, 0.2);
        color: #cfe5ff;
        border: 1px solid rgba(96, 165, 250, 0.4);
      }

      .chat-body {
        background: var(--bg);
      }

      .chat {
        gap: 12px;
      }

      .chat-window {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 14px;
        border-radius: 16px;
        background: rgba(15, 16, 24, 0.6);
        border: 1px solid var(--border);
        overflow-y: auto;
        max-height: 70vh;
        min-height: 0;
      }

      .bubble {
        max-width: 85%;
        padding: 10px 12px;
        border-radius: 14px 14px 14px 4px;
        background: var(--bubble-in);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .bubble.out {
        align-self: flex-end;
        background: var(--bubble-out);
        color: #e8fffb;
        border-radius: 14px 14px 4px 14px;
      }

      .system-message {
        align-self: center;
        max-width: 90%;
        padding: 6px 10px;
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        background: rgba(15, 16, 24, 0.35);
        border: 1px solid var(--border);
        border-radius: 999px;
      }

      .meta {
        font-size: 11px;
        color: #cbd5e1;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .composer {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Home view: room creation/join entry point -->
      <div id="homeView">
        <header class="app-header">
          <div>
            <h1>C2C Client</h1>
            <p class="muted">Create or join a room to start chatting.</p>
          </div>
        </header>

        <section class="card">
          <h2>Room Actions</h2>
          <div class="actions">
            <button class="btn primary" id="createRoomBtn">Create Room</button>
            <button class="btn" id="joinRoomBtn">Join Room</button>
          </div>
        </section>

        <section class="card">
          <h2>Quick Tips</h2>
          <ul class="list">
            <li>Use a unique nickname for each device.</li>
            <li>Share the Room ID to invite others.</li>
            <li>Chat view is optimized for phones.</li>
          </ul>
        </section>
      </div>

      <!-- Chat view: room header + message list + composer -->
      <div id="chatView" class="hidden">
        <header class="app-header">
          <div>
            <h1 id="roomTitle">Room</h1>
            <p class="muted" id="roomMeta">Connected</p>
            <div class="entries-wrap" id="entriesWrap">
              <button class="entries-trigger" id="entriesBtn" type="button">Entries</button>
              <div class="entries-panel" id="entriesPanel">
                <ul class="entries-list" id="entriesList"></ul>
              </div>
            </div>
          </div>
          <button class="pill" id="backToHomeBtn">Back</button>
        </header>

        <!-- Message stream -->
        <section class="chat-window" id="chatWindow" aria-live="polite"></section>

        <!-- Message composer -->
        <form class="composer" id="chatComposer" action="#" method="post">
          <input type="text" id="chatInput" placeholder="Type a message..." />
          <button class="btn primary" type="submit">Send</button>
        </form>
      </div>
    </div>

    <!-- Create room modal -->
    <div class="modal-backdrop" id="createRoomModal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Create Room</h3>
          <button class="icon-btn" id="closeModalBtn" aria-label="Close">✕</button>
        </div>
        <p class="muted">Enter a nickname to create a room.</p>
        <label class="field">
          <span>Nickname</span>
          <input type="text" id="nicknameInput" placeholder="nick" />
        </label>
        <div class="actions">
          <button class="btn primary" id="confirmCreateBtn">Create</button>
          <button class="btn" id="cancelCreateBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Join room modal -->
    <div class="modal-backdrop" id="joinRoomModal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Join Room</h3>
          <button class="icon-btn" id="closeJoinModalBtn" aria-label="Close">✕</button>
        </div>
        <p class="muted">Enter a nickname and room ID to join.</p>
        <label class="field">
          <span>Nickname</span>
          <input type="text" id="joinNicknameInput" placeholder="nick" />
        </label>
        <label class="field">
          <span>Room ID</span>
          <input type="text" id="joinRoomIdInput" placeholder="room-123" />
        </label>
        <div class="actions">
          <button class="btn primary" id="confirmJoinBtn">Join</button>
          <button class="btn" id="cancelJoinBtn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Join flow progress modal -->
    <div class="modal-backdrop" id="joinProgressModal" aria-hidden="true">
      <div class="modal progress">
        <div class="spinner" aria-hidden="true"></div>
        <h3>Joining...</h3>
        <p class="muted" id="joinProgressText">요청을 보내는 중...</p>
      </div>
    </div>

    <!-- Owner approval modal for join requests -->
    <div class="modal-backdrop" id="joinApproveModal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Join Request</h3>
          <button class="icon-btn" id="closeJoinApproveBtn" aria-label="Close">✕</button>
        </div>
        <p class="muted" id="joinApproveText">새로운 참여 요청이 있습니다.</p>
        <div class="actions">
          <button class="btn primary" id="approveJoinBtn">Approve</button>
          <button class="btn" id="denyJoinBtn">Deny</button>
        </div>
      </div>
    </div>

    <!-- Generic system notice modal -->
    <div class="modal-backdrop" id="systemModal" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <h3>Notice</h3>
          <button class="icon-btn" id="closeSystemModalBtn" aria-label="Close">✕</button>
        </div>
        <p class="muted" id="systemModalText">알림</p>
        <div class="actions">
          <button class="btn primary" id="confirmSystemModalBtn">닫기</button>
        </div>
      </div>
    </div>

    <script>
      // DOM handles
      const createRoomBtn = document.getElementById("createRoomBtn");
      const homeView = document.getElementById("homeView");
      const chatView = document.getElementById("chatView");
      const roomTitle = document.getElementById("roomTitle");
      const roomMeta = document.getElementById("roomMeta");
      const backToHomeBtn = document.getElementById("backToHomeBtn");
      const chatWindow = document.getElementById("chatWindow");
      const chatComposer = document.getElementById("chatComposer");
      const chatInput = document.getElementById("chatInput");
      const entriesWrap = document.getElementById("entriesWrap");
      const entriesBtn = document.getElementById("entriesBtn");
      const entriesList = document.getElementById("entriesList");
      const createRoomModal = document.getElementById("createRoomModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const cancelCreateBtn = document.getElementById("cancelCreateBtn");
      const confirmCreateBtn = document.getElementById("confirmCreateBtn");
      const nicknameInput = document.getElementById("nicknameInput");
      const joinRoomBtn = document.getElementById("joinRoomBtn");
      const joinRoomModal = document.getElementById("joinRoomModal");
      const closeJoinModalBtn = document.getElementById("closeJoinModalBtn");
      const cancelJoinBtn = document.getElementById("cancelJoinBtn");
      const confirmJoinBtn = document.getElementById("confirmJoinBtn");
      const joinNicknameInput = document.getElementById("joinNicknameInput");
      const joinRoomIdInput = document.getElementById("joinRoomIdInput");
      const joinProgressModal = document.getElementById("joinProgressModal");
      const joinProgressText = document.getElementById("joinProgressText");
      const joinApproveModal = document.getElementById("joinApproveModal");
      const joinApproveText = document.getElementById("joinApproveText");
      const closeJoinApproveBtn = document.getElementById("closeJoinApproveBtn");
      const approveJoinBtn = document.getElementById("approveJoinBtn");
      const denyJoinBtn = document.getElementById("denyJoinBtn");
      const systemModal = document.getElementById("systemModal");
      const systemModalText = document.getElementById("systemModalText");
      const closeSystemModalBtn = document.getElementById("closeSystemModalBtn");
      const confirmSystemModalBtn = document.getElementById("confirmSystemModalBtn");
      // Join/create flow state
      let joinState = {
        nickname: "",
        roomId: "",
        requestId: "",
        acked: false,
        approved: false,
        joinRequestId: "",
      };
      // Create flow state
      let createState = {
        nickname: "",
        roomId: "",
        requestId: "",
      };
      // Current session state for the chat view
      let currentRoomId = "";
      let currentNickname = "";
      let currentUserId = "";
      let currentOwnerId = "";
      let currentEntries = [];
      let pendingJoinRequest = null;

      // Home -> create modal controls
      const openModal = () => {
        createRoomModal.setAttribute("aria-hidden", "false");
        createRoomModal.classList.add("open");
        nicknameInput.focus();
      };

      const closeModal = () => {
        createRoomModal.setAttribute("aria-hidden", "true");
        createRoomModal.classList.remove("open");
        nicknameInput.value = "";
      };

      // Home -> join modal controls
      const openJoinModal = () => {
        joinRoomModal.setAttribute("aria-hidden", "false");
        joinRoomModal.classList.add("open");
        joinNicknameInput.focus();
      };

      const closeJoinModal = () => {
        joinRoomModal.setAttribute("aria-hidden", "true");
        joinRoomModal.classList.remove("open");
        joinNicknameInput.value = "";
        joinRoomIdInput.value = "";
      };

      // Join flow progress modal controls
      const openJoinProgress = (message) => {
        joinProgressText.textContent = message;
        joinProgressModal.setAttribute("aria-hidden", "false");
        joinProgressModal.classList.add("open");
      };

      const updateJoinProgress = (message) => {
        joinProgressText.textContent = message;
      };

      const closeJoinProgress = () => {
        joinProgressModal.setAttribute("aria-hidden", "true");
        joinProgressModal.classList.remove("open");
      };

      // Surface join status on home or as chat system text
      const showJoinStatusOnHome = (message) => {
        if (chatView.classList.contains("hidden")) {
          openJoinProgress(message);
        } else {
          appendSystemMessage(message);
        }
      };

      // Owner approval modal for JOIN_REQUEST NOTIFY
      const openJoinApproveModal = (payload) => {
        pendingJoinRequest = payload;
        const name = payload.nickname || payload.requestedUserId || "someone";
        joinApproveText.textContent = `${name} 님이 참여를 요청했습니다.`;
        joinApproveModal.setAttribute("aria-hidden", "false");
        joinApproveModal.classList.add("open");
      };

      // Close owner approval modal
      const closeJoinApproveModal = () => {
        joinApproveModal.setAttribute("aria-hidden", "true");
        joinApproveModal.classList.remove("open");
        pendingJoinRequest = null;
      };

      // Generic system modal (used for deny notice, etc.)
      const openSystemModal = (message) => {
        systemModalText.textContent = message;
        systemModal.setAttribute("aria-hidden", "false");
        systemModal.classList.add("open");
      };

      // Close generic system modal
      const closeSystemModal = () => {
        systemModal.setAttribute("aria-hidden", "true");
        systemModal.classList.remove("open");
      };

      // Send command frame to server
      const sendCommand = (action, payload) => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          appendSystemMessage("연결이 끊어졌습니다.");
          return null;
        }
        const frame = {
          requestId: `req-${Date.now()}`,
          type: "COMMAND",
          action,
          payload: payload ? JSON.stringify(payload) : null,
        };
        socket.send(JSON.stringify(frame));
        return frame.requestId;
      };

      // Send ACK frame for eventId (ACK does not ACK itself)
      const sendAckFrame = (eventId) => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          return;
        }
        const frame = {
          requestId: `ack-${Date.now()}`,
          eventId,
          type: "ACK",
        };
        socket.send(JSON.stringify(frame));
      };

      // Request to join a room (owner approval flow)
      const sendJoinRequest = async () => {
        const requestId = sendCommand("JOIN_REQUEST", {
          roomId: joinState.roomId,
          nickName: joinState.nickname,
        });
        if (requestId) {
          joinState.requestId = requestId;
        }
      };

      // Final join command after approval or create
      const sendJoin = async (roomId, nickname) => {
        const requestId = sendCommand("JOIN", {
          roomId,
          nickName: nickname,
        });
        if (requestId) {
          joinState.roomId = roomId;
          joinState.nickname = nickname;
          joinState.joinRequestId = requestId;
        }
      };

      // Owner approves/denies join request
      const sendJoinApprove = async (roomId, requestedUserId, approved) => {
        sendCommand("JOIN_APPROVE", {
          roomId,
          requestedUserId,
          approved,
        });
      };

      // Create room command
      const sendRoomCreate = async () => {
        const requestId = sendCommand("ROOM_CREATE", null);
        if (requestId) {
          createState.requestId = requestId;
        }
      };

      // WebSocket base URL
      const wsBaseUrl = "ws://jhhomehub.gonetis.com/ws";

      let socket = null;
      let heartbeatTimer = null;
      let heartbeatAckTimer = null;
      let heartbeatRequestId = "";
      let reconnectTimer = null;
      let reconnecting = false;
      const HEARTBEAT_INTERVAL_MS = 10000;
      const HEARTBEAT_ACK_TIMEOUT_MS = 7000;
      const RECONNECT_DELAY_MS = 500;

      // Heartbeat loop (server expects HEARTBEAT command)
      const startHeartbeat = () => {
        stopHeartbeat();
        heartbeatTimer = setInterval(() => {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            return;
          }
          const frame = {
            requestId: `hb-${Date.now()}`,
            type: "COMMAND",
            action: "HEARTBEAT",
            payload: "",
          };
          heartbeatRequestId = frame.requestId;
          socket.send(JSON.stringify(frame));
          armHeartbeatTimeout();
        }, HEARTBEAT_INTERVAL_MS);
      };

      // Stop heartbeat and pending timeout
      const stopHeartbeat = () => {
        if (heartbeatTimer) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
        }
        if (heartbeatAckTimer) {
          clearTimeout(heartbeatAckTimer);
          heartbeatAckTimer = null;
        }
      };

      // If heartbeat ACK doesn't arrive, force reconnect
      const armHeartbeatTimeout = () => {
        if (heartbeatAckTimer) {
          clearTimeout(heartbeatAckTimer);
        }
        heartbeatAckTimer = setTimeout(() => {
          if (!socket || socket.readyState !== WebSocket.OPEN) {
            return;
          }
          reconnectSocket("heartbeat timeout");
        }, HEARTBEAT_ACK_TIMEOUT_MS);
      };

      // Controlled reconnect after a short delay
      const reconnectSocket = (reason) => {
        if (reconnecting) return;
        reconnecting = true;
        stopHeartbeat();
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
        }
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
        }
        reconnectTimer = setTimeout(() => {
          reconnecting = false;
          connectSocket();
        }, RECONNECT_DELAY_MS);
        if (roomMeta) {
          roomMeta.textContent = `Reconnecting (${reason})`;
        }
      };

      // Establish WS and wire listeners
      const connectSocket = () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          return;
        }
        socket = new WebSocket(wsBaseUrl);
        socket.onopen = () => {
          if (roomMeta) {
            roomMeta.textContent = "Connected";
          }
          startHeartbeat();
        };
        socket.onmessage = (event) => handleSocketMessage(event.data);
        socket.onclose = () => {
          stopHeartbeat();
          handleSocketClosed();
        };
        socket.onerror = () => {
          if (roomMeta) {
            roomMeta.textContent = "Connection error";
          }
        };
      };

      // When WS closes, return to home if in room
      const handleSocketClosed = () => {
        if (roomMeta) {
          roomMeta.textContent = "Disconnected";
        }
        if (!chatView.classList.contains("hidden")) {
          appendSystemMessage("연결이 종료되었습니다. 홈으로 이동합니다.");
          exitRoom();
        }
      };

      // System message (centered) in chat
      const appendSystemMessage = (text) => {
        const notice = document.createElement("div");
        notice.className = "system-message";
        notice.textContent = text;
        chatWindow.appendChild(notice);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      };

      // Render entries list and owner/self markers
      const updateEntriesUI = () => {
        if (!entriesWrap || !entriesBtn || !entriesList) {
          return;
        }
        const count = currentEntries.length;
        entriesBtn.textContent = `Entries (${count})`;
        entriesList.innerHTML = "";
        if (!count) {
          const empty = document.createElement("li");
          empty.className = "entries-item muted";
          empty.textContent = "No participants";
          entriesList.appendChild(empty);
          return;
        }
        currentEntries.forEach((entry) => {
          const item = document.createElement("li");
          item.className = "entries-item";
          const isOwner = currentOwnerId && entry.userId === currentOwnerId;
          const isSelf = currentUserId && entry.userId === currentUserId;
          if (isOwner) {
            item.classList.add("is-owner");
          }
          if (isSelf) {
            item.classList.add("is-self");
          }
          const name = entry.nickname || entry.userId || "user";
          item.textContent = name;
          if (isOwner) {
            const badge = document.createElement("span");
            badge.className = "owner-badge";
            badge.textContent = "owner";
            item.appendChild(badge);
          }
          entriesList.appendChild(item);
        });
      };

      // Normal chat bubble message
      const appendMessage = (text, sender, isSelf) => {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${isSelf ? "out" : "in"}`;
        bubble.innerHTML = `<div class="meta">${sender}</div><p>${text}</p>`;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      };

      // Safe JSON payload parsing
      const parsePayload = (raw) => {
        if (!raw) return null;
        if (typeof raw === "object") return raw;
        if (typeof raw !== "string") return null;
        try {
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      };

      // ACK frames for commands + heartbeat ACK tracking
      const handleAck = (message) => {
        if (message.requestId && message.requestId === heartbeatRequestId) {
          if (heartbeatAckTimer) {
            clearTimeout(heartbeatAckTimer);
            heartbeatAckTimer = null;
          }
          return;
        }
        if (message.action === "ROOM_CREATE" && message.requestId === createState.requestId) {
          updateJoinProgress("방 생성 요청 수신됨...");
          return;
        }
        if (message.action === "JOIN_REQUEST" && message.requestId === joinState.requestId) {
          updateJoinProgress("승인을 기다리고 있습니다...");
          return;
        }
        if (message.action === "JOIN" && message.requestId === joinState.joinRequestId) {
          updateJoinProgress("참여 처리 중...");
        }
      };

      // RESULT frames for create/join flows
      const handleResult = (message) => {
        const payload = parsePayload(message.payload);

        if (message.action === "ROOM_CREATE") {
          if (message.status === "ERROR") {
            updateJoinProgress("방 생성 실패.");
            closeJoinProgress();
            return;
          }
          const roomId = payload?.roomId;
          const ownerId = payload?.ownerId;
          if (roomId) {
            createState.roomId = roomId;
          }
          if (ownerId) {
            currentOwnerId = ownerId;
          }
          updateJoinProgress("방 생성 완료. 참여 처리 중...");
          sendJoin(createState.roomId, createState.nickname);
          return;
        }

        if (message.action === "JOIN") {
          if (message.status === "ERROR") {
            updateJoinProgress("참여 실패.");
            closeJoinProgress();
            return;
          }
          const roomId = payload?.roomId || joinState.roomId;
          const ownerId = payload?.ownerId;
          const entries = Array.isArray(payload?.entries) ? payload.entries : [];
          if (ownerId) {
            currentOwnerId = ownerId;
          }
          if (entries.length) {
            currentEntries = entries;
          }
          closeJoinProgress();
          enterRoom(roomId, joinState.nickname || createState.nickname);
          updateEntriesUI();
          return;
        }

        if (message.action === "JOIN_REQUEST") {
          if (message.status === "ERROR") {
            updateJoinProgress("승인 요청 실패.");
            closeJoinProgress();
          }
          return;
        }
      };

      // NOTIFY frames for JOIN/LEAVE/JOIN_REQUEST/JOIN_APPROVE
      const handleNotify = (message) => {
        const payload = parsePayload(message.payload);
        if (!payload) return;

        if (message.action === "JOIN") {
          appendSystemMessage(`${payload.nickname || payload.userId} joined.`);
          if (payload.userId) {
            const exists = currentEntries.some(
              (entry) => entry.userId === payload.userId
            );
            if (!exists) {
              currentEntries = [
                ...currentEntries,
                { userId: payload.userId, nickname: payload.nickname || "" },
              ];
            }
            updateEntriesUI();
          }
          return;
        }

        if (message.action === "LEAVE") {
          appendSystemMessage(`${payload.nickname || payload.userId} left.`);
          if (payload.newOwnerId) {
            currentOwnerId = payload.newOwnerId;
          }
          if (payload.userId) {
            currentEntries = currentEntries.filter(
              (entry) => entry.userId !== payload.userId
            );
          }
          updateEntriesUI();
          return;
        }

        if (message.action === "JOIN_REQUEST") {
          if (
            currentUserId &&
            currentOwnerId &&
            currentUserId === currentOwnerId &&
            payload.roomId === currentRoomId
          ) {
            openJoinApproveModal(payload);
          }
          return;
        }

        if (message.action === "JOIN_APPROVE") {
          if (payload.requestedUserId && payload.requestedUserId !== currentUserId) {
            return;
          }
          if (payload.approved) {
            showJoinStatusOnHome("참여 요청이 승인되었습니다.");
            sendJoin(payload.roomId, joinState.nickname);
          } else {
            closeJoinProgress();
            openSystemModal("참여가 거부되었습니다.");
          }
        }
      };

      // WS message router (ACK/RESULT/NOTIFY/MESSAGE/SYSTEM)
      const handleSocketMessage = (data) => {
        let message;
        try {
          message = JSON.parse(data);
        } catch (e) {
          return;
        }

        if (message.type !== "ACK" && message.eventId) {
          sendAckFrame(message.eventId);
        }

        if (message.type === "SYSTEM" && message.action === "CONN_OPENED") {
          const payload = parsePayload(message.payload);
          if (payload?.userId) {
            currentUserId = payload.userId;
          }
          return;
        }

        if (message.type === "ACK") {
          handleAck(message);
          return;
        }

        if (message.type === "RESULT") {
          handleResult(message);
          return;
        }

        if (message.type === "NOTIFY") {
          handleNotify(message);
          return;
        }

        if (message.type === "MESSAGE" && message.action === "CLIENT_MESSAGE") {
          let payload = null;
          try {
            payload = message.payload ? JSON.parse(message.payload) : null;
          } catch (e) {
            payload = null;
          }
          if (payload) {
            const sender = payload.nickname || payload.userId || "user";
            const isSelf = payload.nickname && payload.nickname === currentNickname;
            appendMessage(payload.message || "", sender, isSelf);
          }
          return;
        }

      };

      // Enter room UI state
      const enterRoom = (roomId, nickname) => {
        currentRoomId = roomId;
        currentNickname = nickname;
        roomTitle.textContent = roomId;
        roomMeta.textContent = `Connected as ${nickname}`;
        chatWindow.innerHTML = "";
        homeView.classList.add("hidden");
        chatView.classList.remove("hidden");
        updateEntriesUI();
      };

      // Leave room UI state and notify server
      const exitRoom = () => {
        if (currentRoomId) {
          sendCommand("LEAVE", { roomId: currentRoomId });
        }
        currentRoomId = "";
        currentNickname = "";
        currentEntries = [];
        currentOwnerId = "";
        chatInput.value = "";
        chatView.classList.add("hidden");
        homeView.classList.remove("hidden");
      };

      // Helper to close progress then enter room
      const navigateToRoom = (roomId, nickname) => {
        closeJoinProgress();
        enterRoom(roomId, nickname);
      };

      // Join flow: send JOIN_REQUEST then wait for approvals
      const runJoinFlow = async () => {
        openJoinProgress("요청을 보내는 중...");
        await sendJoinRequest();
        if (!joinState.requestId) {
          closeJoinProgress();
        }
      };

      // Create flow: send ROOM_CREATE and wait for RESULT
      const runCreateFlow = async () => {
        openJoinProgress("방을 생성 요청중입니다...");
        await sendRoomCreate();
        if (!createState.requestId) {
          closeJoinProgress();
        }
      };

      // Home controls
      createRoomBtn.addEventListener("click", openModal);
      closeModalBtn.addEventListener("click", closeModal);
      cancelCreateBtn.addEventListener("click", closeModal);
      createRoomModal.addEventListener("click", (event) => {
        if (event.target === createRoomModal) {
          closeModal();
        }
      });
      confirmCreateBtn.addEventListener("click", () => {
        const nickname = nicknameInput.value.trim();
        if (!nickname) {
          nicknameInput.focus();
          return;
        }
        closeModal();
        createState = {
          nickname,
          roomId: "",
          requestId: "",
        };
        runCreateFlow();
      });

      // Join controls
      joinRoomBtn.addEventListener("click", openJoinModal);
      closeJoinModalBtn.addEventListener("click", closeJoinModal);
      cancelJoinBtn.addEventListener("click", closeJoinModal);
      joinRoomModal.addEventListener("click", (event) => {
        if (event.target === joinRoomModal) {
          closeJoinModal();
        }
      });
      confirmJoinBtn.addEventListener("click", () => {
        const nickname = joinNicknameInput.value.trim();
        const roomId = joinRoomIdInput.value.trim();
        if (!nickname) {
          joinNicknameInput.focus();
          return;
        }
        if (!roomId) {
          joinRoomIdInput.focus();
          return;
        }
        closeJoinModal();
        joinState = {
          nickname,
          roomId,
          requestId: "",
          acked: false,
          approved: false,
          joinRequestId: "",
        };
        runJoinFlow();
      });

      // Back button leaves the room
      backToHomeBtn.addEventListener("click", exitRoom);

      // Owner approval modal controls
      closeJoinApproveBtn.addEventListener("click", closeJoinApproveModal);
      joinApproveModal.addEventListener("click", (event) => {
        if (event.target === joinApproveModal) {
          closeJoinApproveModal();
        }
      });
      approveJoinBtn.addEventListener("click", () => {
        if (!pendingJoinRequest) return;
        sendJoinApprove(
          pendingJoinRequest.roomId,
          pendingJoinRequest.requestedUserId,
          true
        );
        closeJoinApproveModal();
      });
      denyJoinBtn.addEventListener("click", () => {
        if (!pendingJoinRequest) return;
        sendJoinApprove(
          pendingJoinRequest.roomId,
          pendingJoinRequest.requestedUserId,
          false
        );
        closeJoinApproveModal();
      });

      // System modal controls
      closeSystemModalBtn.addEventListener("click", closeSystemModal);
      confirmSystemModalBtn.addEventListener("click", closeSystemModal);
      systemModal.addEventListener("click", (event) => {
        if (event.target === systemModal) {
          closeSystemModal();
        }
      });

      // Chat composer -> CLIENT_MESSAGE command
      chatComposer.addEventListener("submit", (event) => {
        event.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;
        if (!currentRoomId) {
          appendSystemMessage("방에 먼저 입장하세요.");
          return;
        }
        const payload = {
          roomId: currentRoomId,
          message,
        };
        const frame = {
          requestId: `req-${Date.now()}`,
          type: "COMMAND",
          action: "CLIENT_MESSAGE",
          payload: JSON.stringify(payload),
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(frame));
          appendMessage(message, "you", true);
          chatInput.value = "";
        } else {
          appendSystemMessage("연결이 끊어졌습니다.");
        }
      });

      // Connect on page load
      connectSocket();
    </script>
  </body>
</html>
