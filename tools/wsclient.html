<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WS Client</title>
    <style>
      body {
        margin: 0;
        padding: 24px;
        font: 14px/1.4 "SFMono-Regular", Menlo, Consolas, monospace;
        background: #0f1419;
        color: #e6edf3;
      }

      label {
        display: block;
        margin-bottom: 6px;
        color: #9fb0c0;
      }

      input,
      textarea,
      button {
        font: inherit;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #27313b;
        border-radius: 6px;
        background: #0b0f13;
        color: #e6edf3;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      button {
        margin-top: 12px;
        padding: 8px 12px;
        border: 1px solid #27313b;
        border-radius: 6px;
        background: #1a2128;
        color: #e6edf3;
        cursor: pointer;
      }

      .row {
        margin-bottom: 16px;
      }

      .row.inline {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .log {
        margin-top: 16px;
        padding: 10px;
        border: 1px solid #27313b;
        border-radius: 6px;
        background: #0b0f13;
        white-space: pre-wrap;
        min-height: 80px;
        max-height: 260px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <label for="url">WebSocket URL</label>
      <input id="url" type="text" value="ws://localhost:8080/ws" />
    </div>

    <div class="row inline">
      <div>
        <label for="userId">User ID (query param)</label>
        <input id="userId" type="text" value="user-1" />
      </div>
      <div>
        <label for="heartbeat">Heartbeat Interval (ms)</label>
        <input id="heartbeat" type="number" value="20000" min="1000" step="1000" />
      </div>
    </div>

    <div class="row">
      <label for="frameJson">Frame JSON (client frame)</label>
      <textarea id="frameJson"></textarea>
    </div>
    <div class="row">
      <label for="payloadJson">Payload JSON (embedded in frame)</label>
      <textarea id="payloadJson"></textarea>
    </div>

    <div class="row">
      <div class="actions">
        <button id="connect">Connect</button>
        <button id="disconnect">Disconnect</button>
        <button id="send">Send Frame</button>
      </div>
    </div>

    <div class="log" id="log">Idle</div>

    <script>
      const urlInput = document.getElementById("url");
      const userIdInput = document.getElementById("userId");
      const heartbeatInput = document.getElementById("heartbeat");
      const frameJsonInput = document.getElementById("frameJson");
      const payloadJsonInput = document.getElementById("payloadJson");
      const connectBtn = document.getElementById("connect");
      const disconnectBtn = document.getElementById("disconnect");
      const sendBtn = document.getElementById("send");
      const logEl = document.getElementById("log");

      let socket = null;
      let heartbeatTimer = null;

      const sampleFrame = {
        requestId: "req-123",
        type: "COMMAND",
        action: "CLIENT_MESSAGE",
      };
      const samplePayload = {
        message: "hello",
      };

      const appendLog = (text) => {
        const line = document.createElement("div");
        line.textContent = text;
        logEl.appendChild(line);
      };

      const buildUrl = () => {
        const base = urlInput.value.trim();
        if (!base) return "";
        const userId = userIdInput.value.trim();
        if (!userId) return base;
        const joiner = base.includes("?") ? "&" : "?";
        return `${base}${joiner}userId=${encodeURIComponent(userId)}`;
      };

      const startHeartbeat = () => {
        const interval = Number(heartbeatInput.value);
        if (!socket || !Number.isFinite(interval) || interval <= 0) return;
        heartbeatTimer = setInterval(() => {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(
              JSON.stringify({
                requestId: `hb-${Date.now()}`,
                type: "COMMAND",
                action: "HEARTBEAT",
                payload: null,
              })
            );
          }
        }, interval);
      };

      const stopHeartbeat = () => {
        if (heartbeatTimer) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
        }
      };

      connectBtn.addEventListener("click", () => {
        const url = buildUrl();
        if (!url) {
          appendLog("URL required.");
          return;
        }
        if (socket && socket.readyState === WebSocket.OPEN) {
          appendLog("Already connected.");
          return;
        }
        socket = new WebSocket(url);
        socket.onopen = () => {
          appendLog(`Connected: ${url}`);
          startHeartbeat();
        };
        socket.onmessage = (event) => {
          appendLog(`Recv: ${event.data}`);
        };
        socket.onerror = () => {
          appendLog("WebSocket error.");
        };
        socket.onclose = (event) => {
          stopHeartbeat();
          appendLog(`Closed: ${event.code} ${event.reason || ""}`.trim());
        };
      });

      disconnectBtn.addEventListener("click", () => {
        if (socket) {
          socket.close(1000, "client close");
        }
      });

      sendBtn.addEventListener("click", () => {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          appendLog("Socket not connected.");
          return;
        }
        const raw = frameJsonInput.value.trim();
        if (!raw) {
          appendLog("Frame JSON required.");
          return;
        }
        let frame;
        try {
          frame = JSON.parse(raw);
        } catch (e) {
          appendLog("Frame JSON parse error.");
          return;
        }
        if (!frame.type) {
          frame.type = "COMMAND";
        }
        const payloadRaw = payloadJsonInput.value.trim();
        if (payloadRaw) {
          try {
            const payloadObj = JSON.parse(payloadRaw);
            frame.payload = JSON.stringify(payloadObj);
          } catch (e) {
            appendLog("Payload JSON parse error.");
            return;
          }
        } else {
          delete frame.payload;
        }
        const outbound = JSON.stringify(frame);
        socket.send(outbound);
        appendLog(`Sent: ${outbound}`);
      });

      frameJsonInput.value = JSON.stringify(sampleFrame, null, 2);
      payloadJsonInput.value = JSON.stringify(samplePayload, null, 2);
    </script>
  </body>
</html>
